<html>

<head>
    <title>Dealers - {{ sap_princ }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .navbar {
            background-color: #2c3e50;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            color: white !important;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .navbar-text {
            color: rgba(255, 255, 255, 0.7) !important;
            font-size: 0.95rem;
        }

        .container-fluid {
            padding: 0 30px;
        }

        .card-main {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            height: 100%;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0 0 10px 0;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .breadcrumb-item a {
            color: #3498db;
            text-decoration: none;
        }

        .breadcrumb-item.active {
            color: #7f8c8d;
        }

        .btn-back {
            background-color: #95a5a6;
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 500;
            text-decoration: none;
            margin-bottom: 20px;
            display: inline-block;
        }

        .btn-back:hover {
            background-color: #7f8c8d;
            color: white;
            text-decoration: none;
        }

        /* Sidebar Styles */
        .sidebar-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .sidebar-item:hover {
            background-color: #f8f9fa;
        }

        .sidebar-item.active {
            background-color: #e8f4f8;
            border-left: 4px solid #3498db;
            font-weight: 600;
        }

        .sidebar-header {
            font-weight: 600;
            color: #7f8c8d;
            padding: 10px 15px;
            text-transform: uppercase;
            font-size: 0.85rem;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        /* Table Styles */
        .comparison-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f2f6;
        }

        .count-badge {
            background-color: #3498db;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            margin-left: 10px;
        }

        .both {
            background-color: #93e0a6 !important;
        }

        .both:hover {
            background-color: #6fcf8a !important;
        }

        .mismatched {
            background-color: #ffe5cc !important;
        }

        table td,
        table th {
            padding: 8px 12px !important;
            font-size: 0.9rem;
        }

        .table thead th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
        }

        tr:hover {
            cursor: pointer;
            background: #f1f2f6 !important;
        }

        .scrollable-table {}

        /* Toggle switch styles */
        .filter-toggle-container {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #27ae60;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }
    
        /* Tooltip moderne pour IWU IDs multiples */
        .iwu-badge-container {
            position: relative;
            cursor: help;
            display: inline-block;
        }
        .iwu-count-badge {
            background-color: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 5px;
            font-weight: 600;
        }
        .iwu-tooltip {
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            text-align: left;
        }
        .iwu-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #2c3e50;
        }
        .iwu-badge-container:hover .iwu-tooltip {
            opacity: 1;
            visibility: visible;
        }
    </style>

        <script>
        // Variables globales pour filtres
        let currentFilter = 'all';
        let currentSearch = '';

        function openUser(id_cree, sap, return_url) {
            var url = "/compare_user?id=" + encodeURIComponent(id_cree) + "&sap=" + encodeURIComponent(sap);
            if (return_url) {
                url += "&return_url=" + encodeURIComponent(return_url);
            }
            window.location = url;
        }

        function filterDealer(element, sap_code) {
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            applyAllFilters();
        }

        function applyAllFilters() {
            var rows = document.querySelectorAll('tr[data-dealer]');
            var ssoCount = 0;
            var idocsCount = 0;

            // Trouver le filtre de concession actif
            var activeItem = document.querySelector('.sidebar-item.active');
            var activeDealerCode = 'all';
            if (activeItem) {
                var onclickAttr = activeItem.getAttribute('onclick');
                var match = onclickAttr ? onclickAttr.match(/filterDealer\(this,\s*'([^']+)'\)/) : null;
                if (match) {
                    activeDealerCode = match[1];
                }
            }

            rows.forEach(row => {
                var rowDealer = row.getAttribute('data-dealer');
                var isGreen = row.classList.contains('both');
                var rowNom = (row.getAttribute('data-nom') || '').toLowerCase();
                var rowPrenom = (row.getAttribute('data-prenom') || '').toLowerCase();
                var rowIwu = (row.getAttribute('data-iwu') || '').toLowerCase();

                // Filtre concession
                var matchesDealerFilter = (activeDealerCode === 'all' || rowDealer === activeDealerCode);

                // Filtre 3 etats
                var matchesStatusFilter = true;
                if (currentFilter === 'both') {
                    matchesStatusFilter = isGreen;
                } else if (currentFilter === 'none') {
                    matchesStatusFilter = !isGreen;
                }

                // Filtre recherche
                var matchesSearch = currentSearch === '' ||
                    rowNom.includes(currentSearch) ||
                    rowPrenom.includes(currentSearch) ||
                    rowIwu.includes(currentSearch);

                // Appliquer
                if (matchesDealerFilter && matchesStatusFilter && matchesSearch) {
                    row.style.display = '';
                    // Compter par table - identifier par le texte du header
                    var table = row.closest('table');
                    if (table) {
                        var container = table.closest('.col-md-6');
                        if (container) {
                            var header = container.querySelector('.comparison-header');
                            if (header && header.textContent.includes('Welcome')) {
                                ssoCount++;
                            } else {
                                idocsCount++;
                            }
                        }
                    }
                } else {
                    row.style.display = 'none';
                }
            });

            // Mettre a jour les compteurs
            var allBadges = document.querySelectorAll('.count-badge');
            allBadges.forEach(badge => {
                var header = badge.closest('.comparison-header');
                if (header && header.textContent.includes('Welcome')) {
                    badge.textContent = ssoCount;
                } else if (header && header.textContent.includes('IDOCS')) {
                    badge.textContent = idocsCount;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Boutons de filtre 3 etats
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.background = 'white';
                    });
                    this.classList.add('active');
                    if (this.dataset.filter === 'both') {
                        this.style.background = '#d5f5e3';
                    } else if (this.dataset.filter === 'none') {
                        this.style.background = '#fff3cd';
                    } else {
                        this.style.background = '#e9ecef';
                    }
                    currentFilter = this.dataset.filter;
                    applyAllFilters();
                });
            });

            // Recherche utilisateur live
            var searchInput = document.getElementById('userSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    currentSearch = this.value.toLowerCase();
                    applyAllFilters();
                });
            }
        });
    </script>
</head>

<body>

    <nav class="navbar navbar-dark">
        <div class="container-fluid d-flex align-items-center">
            <a href="/" class="navbar-brand">DealerView</a>
            <span class="navbar-text ml-3">{{ sap_princ }} - {{ sap_nom_princ }}</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Accueil</a></li>
                <li class="breadcrumb-item active">SAP Principal {{ sap_princ }}</li>
            </ol>
        </nav>

        
        <!-- STATISTIQUES GLOBALES -->
        {% if dealer_stats %}
        <div class="stats-bar" style="display: flex; gap: 15px; flex-wrap: wrap; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px;">
            <div style="flex: 1; min-width: 110px; text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <div style="font-size: 1.4rem; font-weight: 600; color: #e74c3c;">{{ dealer_stats.total_sso }}</div>
                <div style="font-size: 0.75rem; color: #7f8c8d;">Welcome</div>
            </div>
            <div style="flex: 1; min-width: 110px; text-align: center; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                <div style="font-size: 1.4rem; font-weight: 600; color: #3498db;">{{ dealer_stats.total_idocs }}</div>
                <div style="font-size: 0.75rem; color: #7f8c8d;">IDOCS</div>
            </div>
            <div style="flex: 1; min-width: 110px; text-align: center; padding: 10px; background: #d5f5e3; border-radius: 6px;">
                <div style="font-size: 1.4rem; font-weight: 600; color: #27ae60;">{{ dealer_stats.in_both }}</div>
                <div style="font-size: 0.75rem; color: #7f8c8d;">Dans les 2</div>
            </div>
            <div style="flex: 1; min-width: 110px; text-align: center; padding: 10px; background: #ffeced; border-radius: 6px;">
                <div style="font-size: 1.4rem; font-weight: 600; color: #e74c3c;">{{ dealer_stats.only_sso }}</div>
                <div style="font-size: 0.75rem; color: #7f8c8d;">Que Welcome</div>
            </div>
            <div style="flex: 1; min-width: 110px; text-align: center; padding: 10px; background: #e8f4f9; border-radius: 6px;">
                <div style="font-size: 1.4rem; font-weight: 600; color: #3498db;">{{ dealer_stats.only_idocs }}</div>
                <div style="font-size: 0.75rem; color: #7f8c8d;">Que IDOCS</div>
            </div>
            <div style="flex: 1; min-width: 110px; text-align: center; padding: 10px; background: #fff3cd; border-radius: 6px;">
                <div style="font-size: 1.4rem; font-weight: 600; color: #856404;">{{ dealer_stats.sso_no_iwu + dealer_stats.idocs_no_iwu }}</div>
                <div style="font-size: 0.75rem; color: #7f8c8d;">Sans IWU ID</div>
            </div>
        </div>
        {% endif %}


        <a href="/" class="btn-back">⬅ Retour à l'accueil</a>
        <!-- INFO CONCESSION (COMPACT) -->
        <div class="alert alert-light mb-3 py-2" style="border-left: 3px solid #3498db;">
            <small class="text-muted"><strong>{{ sap_princ }}</strong> - Noms trouvés:</small>
            {% if welcome_names|length > 0 %}
            <span class="ml-2" style="color: #e74c3c; font-weight: 600;">Welcome:</span>
            {% for name in welcome_names %}
            <span class="badge badge-danger mx-1" style="font-weight: normal;">{{ name }}</span>
            {% endfor %}
            {% endif %}
            {% if idocs_names|length > 0 %}
            <span class="ml-2" style="color: #3498db; font-weight: 600;">IDOCS:</span>
            {% for name in idocs_names %}
            <span class="badge badge-info mx-1" style="font-weight: normal;">{{ name }}</span>
            {% endfor %}
            {% endif %}
        </div>

        <div class="row">
            <!-- SIDEBAR FILTRE -->
            <div class="col-md-3">
                <div class="card-main p-0" style="overflow: hidden;">
                    <div class="sidebar-header">
                        Filtrer par concession
                    </div>
                    <div class="sidebar-item active" onclick="filterDealer(this, 'all')">
                        TOUTES LES CONCESSIONS
                    </div>
                    {% for d in dealers %}
                    <div class="sidebar-item" onclick="filterDealer(this, '{{ d.sap_dealer }}')">
                        <div><strong></strong>{{ d.sap_dealer }}</strong></div>
                        {% if d.name_welcome and d.name_idocs and d.name_welcome != d.name_idocs %}
                        <div style="font-size: 0.85em; margin-top: 2px;">
                            <span style="color: #e74c3c;">W:</span> {{ d.name_welcome }}<br>
                            <span style="color: #3498db;">I:</span> {{ d.name_idocs }}
                        </div>
                        {% elif d.name_welcome %}
                        <div style="font-size: 0.85em;">{{ d.name_welcome }}</div>
                        {% elif d.name_idocs %}
                        <div style="font-size: 0.85em;">{{ d.name_idocs }}</div>
                        {% endif %}
                        {% if d.source == 'both' %}
                        <span class="badge badge-success badge-sm ml-1" style="font-size: 0.7em;">W+I</span>
                        {% elif d.source == 'welcome' %}
                        <span class="badge badge-danger badge-sm ml-1" style="font-size: 0.7em;">W</span>
                        {% else %}
                        <span class="badge badge-info badge-sm ml-1" style="font-size: 0.7em;">I</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

                        <!-- MAIN CONTENT -->
            <div class="col-md-9">
                <!-- FILTRES ET RECHERCHE -->
                <div class="filter-container" style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <!-- Boutons 3 etats -->
                    <div class="btn-group" role="group">
                        <button class="filter-btn active" data-filter="all" style="padding: 8px 16px; border: 1px solid #dfe6e9; background: white; cursor: pointer; border-radius: 6px 0 0 6px;">
                            Tous
                        </button>
                        <button class="filter-btn" data-filter="both" style="padding: 8px 16px; border: 1px solid #dfe6e9; border-left: none; background: white; cursor: pointer;">
                            <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #2ecc71; margin-right: 6px;"></span>Correspondances
                        </button>
                        <button class="filter-btn" data-filter="none" style="padding: 8px 16px; border: 1px solid #dfe6e9; border-left: none; background: white; cursor: pointer; border-radius: 0 6px 6px 0;">
                            <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #bdc3c7; border: 1px solid #95a5a6; margin-right: 6px;"></span>Sans correspondance
                        </button>
                    </div>
                    <!-- Recherche utilisateur -->
                    <input type="text" id="userSearchInput" class="search-user-input" placeholder="Rechercher nom, prenom ou IWU ID..." style="border: 1px solid #dfe6e9; border-radius: 6px; padding: 8px 15px; font-size: 0.9rem; width: 280px;">
                </div>

                <div class="row">
                    <!-- TABLEAU SSO -->
                    <div class="col-md-6">
                        <div class="card-main">
                            <div class="comparison-header">
                                Fichier Welcome
                                <span class="count-badge" style="background-color: #e74c3c;">{{ count_sso }}</span>
                            </div>
                            <div class="scrollable-table">
                                {{ sso|safe }}
                            </div>
                        </div>
                    </div>

                    <!-- TABLEAU IDOCS -->
                    <div class="col-md-6">
                        <div class="card-main">
                            <div class="comparison-header">
                                Fichier IDOCS
                                <span class="count-badge">{{ count_idocs }}</span>
                            </div>
                            <div class="scrollable-table">
                                {{ idocs|safe }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</body>

</html>